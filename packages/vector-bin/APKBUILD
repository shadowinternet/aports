# Maintainer: Mackenzie Hauck <mackenzie@shadowinternet.ca>
pkgname=vector-bin
pkgver=0.52.0
pkgrel=1
pkgdesc="High-performance observability data pipeline (pre-built binary)"
url="https://vector.dev"
arch="x86_64 aarch64"
license="MPL-2.0"
depends=""
pkgusers="vector"
pkggroups="vector"
provides="vector=$pkgver-r$pkgrel"
install="$pkgname.pre-install $pkgname.post-install"
options="!check"  # Pre-built binary

# Map Alpine arch to Vector arch
case "$CARCH" in
	x86_64)  _varch="x86_64-unknown-linux-musl" ;;
	aarch64) _varch="aarch64-unknown-linux-musl" ;;
esac

source="
	https://packages.timber.io/vector/$pkgver/vector-$pkgver-$_varch.tar.gz
	vector-bin.initd
	vector-bin.confd
	vector.toml
"

# Output to shadow-aports repo structure
export REPODEST="$HOME/packages/shadow-aports"

unpack() {
	mkdir -p "$srcdir"
	tar -xzf "$srcdir/vector-$pkgver-$_varch.tar.gz" -C "$srcdir" --strip-components=2
}

package() {
	# Install binary
	install -Dm755 "$srcdir/bin/vector" "$pkgdir/usr/bin/vector"

	# Install OpenRC service
	install -Dm755 "$srcdir/vector-bin.initd" "$pkgdir/etc/init.d/vector"
	install -Dm644 "$srcdir/vector-bin.confd" "$pkgdir/etc/conf.d/vector"

	# Install default configuration
	install -Dm644 "$srcdir/vector.toml" "$pkgdir/etc/vector/vector.toml"

	# Install license
	install -Dm644 "$srcdir/LICENSE" "$pkgdir/usr/share/licenses/$pkgname/LICENSE"

	# Create directories
	install -dm755 -o vector -g vector "$pkgdir/var/lib/vector"
	install -dm755 -o vector -g vector "$pkgdir/var/log/vector"
}

sha512sums="
203f67c16891a8eb0d18845497b205dc9fa8e21e5be40a2f1375704a8055a7e8d3b141105873707c4322f5b6c1d9d86bd3fee2066058aaf9ce891465063860e4  vector-0.52.0-x86_64-unknown-linux-musl.tar.gz
4e52ac654a9c3f1ed3b758d5eec40825e2a8332f8d172f968f6ecbc54b297660c938af1ff9d032351efe66450d9b037c34763278864120708b1b87026b1351e0  vector-bin.initd
8f04082c40225fec5ff64114f1be1c7668919da45b4657d5bed40ea813a817f6fc486ba28b0976fb52d9d9f5d63304ca850c6a639d3f48dc96295c8167364a67  vector-bin.confd
f8cdee3f660c21f95d27c6146a4f46f2385b0779c338802ee36dc1d5c5726059213059694a3a262c4673506be5b53ba9bfb1b113f043b5d216afb2c59c321bd0  vector.toml
"
